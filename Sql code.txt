SELECT
    CASE WHEN TableName = 'F1' THEN code.DATE_EFFECTIVE_FROM
         ELSE CONVERT(date, '{&DATE_KEY_CRITERIA}') END AS DATE_EFFECTIVE_FROM,
    CASE WHEN TableName = 'F1' THEN CONVERT(date, '{&DATE_KEY_CRITERIA}')
         ELSE CONVERT(date, '31 Dec 2049') END AS DATE_EFFECTIVE_TILL,
    CASE WHEN TableName = 'F1' THEN 'N'
         ELSE 'Y' END AS CURRENT_VERSION_FLAG,
    changerows.*
FROM
    (SELECT
        MIN(Tablename) AS TableName,
        MIN(surrogate_key) AS surrogate_key,
        YEAR,
        student_Count,
        COURSE_FK,
        fund_group_code,
        fund_group_full_desc,
        fund_summary_code,
        fund_summary_full_desc,
        CAMPUS_FK,
        DEPARTMENTHIER_FK,
        IGNORED_HRS,
        GROSS_ENROLLED_HRS,
        ENROLLED_HRS,
        WITHDRAWN_NEVER_ATT_HRS,
        WITHDRAWN_ATTENDED_HRS,
        NETT_ENROLLED_HRS,
        NOT_COMMENCED_HRS,
        YEAR_EFTSL,
        PREENROLLED_HRS,
        COMMENCED_NOT_COMP_HRS,
        SVTS_PAID_AMOUNT,
        SVTS_PAID_HOURS,
        SVTS_REJECT_HOURS,
        SVTS_REJECT_AMOUNT,
        RESULTED_HRS,
        AWAITING_SIGNOFF_HRS,
        INTAKE_INDICATOR,
        ENROLMENT_TYPE,
        INSUFFICIENT_PARTIC_HRS,
        Missing_Attend_Hours,
        Attend_Completed_Hours,
        Attend_in_Progress_Hours,
        Missing_Result_Hours,
        Future_Attenda_Hours,
        Ignored_Attend_Units,
        WNA_UNITS,
        Missing_Attend_Units,
        Attend_Completed_Units,
        Attend_in_Progress_Units,
        Missing_Result_Units,
        Future_Attend_Units,
        attendancegroupcode,
        AttendanceGroupName,
        GroupKeyWords,
        GroupNotes,
        COMMENCED_HOURS,
        CY_CLAIMABLE_SVTS_HOURS,
        YTD_CLAIMABLE_SVTS_HOURS,
        R27_HOURS,
        R27_UNITS,
        R27_EX_WAIT_UNITS,
        R27_EX_WAIT_HOURS,
        R27_WAIT_UNITS,
        R27_WAIT_HOURS,
        R27_HOURS_7DAYS,
        R27_UNITS_7DAYS,
        R27_EX_WAIT_UNITS_7DAYS,
        R27_EX_WAIT_HOURS_7DAYS,
        R27_WAIT_UNITS_7DAYS,
        R27_WAIT_HOURS_7DAYS,
        R27_HOURS_30DAYS,
        R27_UNITS_30DAYS,
        R27_EX_WAIT_UNITS_30DAYS,
        R27_EX_WAIT_HOURS_30DAYS,
        R27_WAIT_UNITS_30DAYS,
        R27_WAIT_HOURS_30DAYS,
        R27_HOURS_60DAYS,
        R27_UNITS_60DAYS,
        R27_EX_WAIT_UNITS_60DAYS,
        R27_EX_WAIT_HOURS_60DAYS,
        R27_WAIT_UNITS_60DAYS,
        R27_WAIT_HOURS_60DAYS,
        R27_HOURS_90DAYS,
        R27_UNITS_90DAYS,
        R27_EX_WAIT_UNITS_90DAYS,
        R27_EX_WAIT_HOURS_90DAYS,
        R27_WAIT_UNITS_90DAYS,
        R27_WAIT_HOURS_90DAYS,
        R27_HOURS_OVER90,
        R27_UNITS_OVER90,
        R27_EX_WAIT_UNITS_OVER90,
        R27_EX_WAIT_HOURS_OVER90,
        R27_WAIT_UNITS_OVER90,
        R27_WAIT_HOURS_OVER90
    FROM
        (SELECT
            'STRATA' AS TableName,
            '0' AS surrogate_key,
            fact.YEAR,
            COUNT(DISTINCT stud.uniqueid) AS student_Count,
            ISNULL(COURSE_FK, -1) AS COURSE_FK,
            ISNULL(fund.fund_group_code, 'Unknown') AS fund_group_code,
            ISNULL(fund.fund_group_full_desc, 'Unknown') AS fund_group_full_desc,
            ISNULL(fund.fund_summary_code, 'Unknown') AS fund_summary_code,
            ISNULL(fund.fund_summary_full_desc, 'Unknown') AS fund_summary_full_desc,
            ISNULL(CAMPUS_FK, -1) AS CAMPUS_FK,
            ISNULL(DEPARTMENTHIER_FK, -1) AS DEPARTMENTHIER_FK,
            SUM(IGNORED_HRS) AS IGNORED_HRS,
            SUM(GROSS_ENROLLED_HRS) AS GROSS_ENROLLED_HRS,
            SUM(ENROLLED_HRS) AS ENROLLED_HRS,
            SUM(WITHDRAWN_NEVER_ATT_HRS) AS WITHDRAWN_NEVER_ATT_HRS,
            SUM(WITHDRAWN_ATTENDED_HRS) AS WITHDRAWN_ATTENDED_HRS,
            SUM(NETT_ENROLLED_HRS) AS NETT_ENROLLED_HRS,
            SUM(NOT_COMMENCED_HRS) AS NOT_COMMENCED_HRS,
            SUM(CAST(YEAR_EFTSL AS decimal(18,6))) AS YEAR_EFTSL,
            SUM(PREENROLLED_HRS) AS PREENROLLED_HRS,
            SUM(COMMENCED_NOT_COMP_HRS) AS COMMENCED_NOT_COMP_HRS,
            SUM(CAST(SVTS_PAID_AMOUNT AS decimal(18,6))) AS SVTS_PAID_AMOUNT,
            SUM(SVTS_PAID_HOURS) AS SVTS_PAID_HOURS,
            SUM(SVTS_REJECT_HOURS) AS SVTS_REJECT_HOURS,
            SUM(CAST(SVTS_REJECT_AMOUNT AS decimal(18,6))) AS SVTS_REJECT_AMOUNT,
            SUM(RESULTED_HRS) AS RESULTED_HRS,
            SUM(AWAITING_SIGNOFF_HRS) AS AWAITING_SIGNOFF_HRS,
            INTAKE_INDICATOR,
            ENROLMENT_TYPE,
            SUM(INSUFFICIENT_PARTIC_HRS) AS INSUFFICIENT_PARTIC_HRS,
            SUM(CASE WHEN PROGRESSION_STATUS = 'Missing Attendance' THEN NETT_ENROLLED_HRS END) AS Missing_Attend_Hours,
            SUM(CASE WHEN PROGRESSION_STATUS = 'Attendance Completed' THEN NETT_ENROLLED_HRS END) AS Attend_Completed_Hours,
            SUM(CASE WHEN PROGRESSION_STATUS = 'Attendance in Progress' THEN NETT_ENROLLED_HRS END) AS Attend_in_Progress_Hours,
            SUM(CASE WHEN PROGRESSION_STATUS = 'Missing Result' THEN NETT_ENROLLED_HRS END) AS Missing_Result_Hours,
            SUM(CASE WHEN PROGRESSION_STATUS = 'Future Attendance' THEN NETT_ENROLLED_HRS END) AS Future_Attenda_Hours,
            COUNT(DISTINCT CASE WHEN PROGRESSION_STATUS = 'Ignored Attendance' THEN fact.id END) AS Ignored_Attend_Units,
            COUNT(DISTINCT CASE WHEN PROGRESSION_STATUS = 'Withdrawn Never Attended Attendance' THEN fact.id END) AS WNA_UNITS,
            COUNT(DISTINCT CASE WHEN PROGRESSION_STATUS = 'Missing Attendance' THEN fact.id END) AS Missing_Attend_Units,
            COUNT(DISTINCT CASE WHEN PROGRESSION_STATUS = 'Attendance Completed' THEN fact.id END) AS Attend_Completed_Units,
            COUNT(DISTINCT CASE WHEN PROGRESSION_STATUS = 'Attendance in Progress' THEN fact.id END) AS Attend_in_Progress_Units,
            COUNT(DISTINCT CASE WHEN PROGRESSION_STATUS = 'Missing Result' THEN fact.id END) AS Missing_Result_Units,
            COUNT(DISTINCT CASE WHEN PROGRESSION_STATUS = 'Future Attendance' THEN fact.id END) AS Future_Attend_Units,
            CASE WHEN DEPARTMENTHIER_FK = '18' THEN COL_STUDY_PERIOD
                 ELSE ISNULL(grp.attendancegroupcode, 'Unknown') END AS attendancegroupcode,
            CASE WHEN DEPARTMENTHIER_FK = '18' THEN COL_STUDY_PERIOD
                 ELSE ISNULL(grp.name, 'Unknown') END AS AttendanceGroupName,
            ISNULL(grp.searchkeywords, 'Unknown') AS GroupKeyWords,
            ISNULL(grp.notes, 'Unknown') AS GroupNotes,
            SUM(COMMENCED_HOURS) AS COMMENCED_HOURS,
            SUM(CY_CLAIMABLE_SVTS_HOURS) AS CY_CLAIMABLE_SVTS_HOURS,
            SUM(YTD_CLAIMABLE_SVTS_HOURS) AS YTD_CLAIMABLE_SVTS_HOURS,
            SUM(CASE WHEN OVERDUE_RESULT_CLASS <> 'Not Overdue' THEN CLASSHOURSQUANTITY END) AS R27_HOURS,
            COUNT(DISTINCT CASE WHEN OVERDUE_RESULT_CLASS <> 'Not Overdue' THEN fact.id END) AS R27_UNITS,
            COUNT(DISTINCT CASE WHEN PROGRESSION_STATUS = 'Missing Result' AND OVERDUE_RESULT_CLASS <> 'Not Overdue' THEN fact.id END) AS R27_EX_WAIT_UNITS,
            SUM(CASE WHEN PROGRESSION_STATUS = 'Missing Result' AND OVERDUE_RESULT_CLASS <> 'Not Overdue' THEN CLASSHOURSQUANTITY END) AS R27_EX_WAIT_HOURS,
            COUNT(DISTINCT CASE WHEN OVERDUE_RESULT_CLASS <> 'Not Overdue' AND PROGRESSION_STATUS = 'Awaiting Employer Signoff' THEN fact.id END) AS R27_WAIT_UNITS,
            SUM(CASE WHEN OVERDUE_RESULT_CLASS <> 'Not Overdue' AND PROGRESSION_STATUS = 'Awaiting Employer Signoff' THEN CLASSHOURSQUANTITY END) AS R27_WAIT_HOURS,
            SUM(CASE WHEN OVERDUE_RESULT_CLASS = '1. Nearing 7 Days overdue' THEN CLASSHOURSQUANTITY END) AS R27_HOURS_7DAYS,
            COUNT(DISTINCT CASE WHEN OVERDUE_RESULT_CLASS = '1. Nearing 7 Days overdue' THEN fact.id END) AS R27_UNITS_7DAYS,
            COUNT(DISTINCT CASE WHEN PROGRESSION_STATUS = 'Missing Result' AND OVERDUE_RESULT_CLASS = '1. Nearing 7 Days overdue' THEN fact.id END) AS R27_EX_WAIT_UNITS_7DAYS,
            SUM(CASE WHEN PROGRESSION_STATUS = 'Missing Result' AND OVERDUE_RESULT_CLASS = '1. Nearing 7 Days overdue' THEN CLASSHOURSQUANTITY END) AS R27_EX_WAIT_HOURS_7DAYS,
            COUNT(DISTINCT CASE WHEN OVERDUE_RESULT_CLASS = '1. Nearing 7 Days overdue' AND PROGRESSION_STATUS = 'Awaiting Employer Signoff' THEN fact.id END) AS R27_WAIT_UNITS_7DAYS,
            SUM(CASE WHEN OVERDUE_RESULT_CLASS = '1. Nearing 7 Days overdue' AND PROGRESSION_STATUS = 'Awaiting Employer Signoff' THEN CLASSHOURSQUANTITY END) AS R27_WAIT_HOURS_7DAYS,
            SUM(CASE WHEN OVERDUE_RESULT_CLASS = '2. Nearing 30 Days overdue' THEN CLASSHOURSQUANTITY END) AS R27_HOURS_30DAYS,
            COUNT(DISTINCT CASE WHEN OVERDUE_RESULT_CLASS = '2. Nearing 30 Days overdue' THEN fact.id END) AS R27_UNITS_30DAYS,
            COUNT(DISTINCT CASE WHEN PROGRESSION_STATUS = 'Missing Result' AND OVERDUE_RESULT_CLASS = '2. Nearing 30 Days overdue' THEN fact.id END) AS R27_EX_WAIT_UNITS_30DAYS,
            SUM(CASE WHEN PROGRESSION_STATUS = 'Missing Result' AND OVERDUE_RESULT_CLASS = '2. Nearing 30 Days overdue' THEN CLASSHOURSQUANTITY END) AS R27_EX_WAIT_HOURS_30DAYS,
            COUNT(DISTINCT CASE WHEN OVERDUE_RESULT_CLASS = '2. Nearing 30 Days overdue' AND PROGRESSION_STATUS = 'Awaiting Employer Signoff' THEN fact.id END) AS R27_WAIT_UNITS_30DAYS,
            SUM(CASE WHEN OVERDUE_RESULT_CLASS = '2. Nearing 30 Days overdue' AND PROGRESSION_STATUS = 'Awaiting Employer Signoff' THEN CLASSHOURSQUANTITY END) AS R27_WAIT_HOURS_30DAYS,
            SUM(CASE WHEN OVERDUE_RESULT_CLASS = '3. Nearing 60 Days overdue' THEN CLASSHOURSQUANTITY END) AS R27_HOURS_60DAYS,
            COUNT(DISTINCT CASE WHEN OVERDUE_RESULT_CLASS = '3. Nearing 60 Days overdue' THEN fact.id END) AS R27_UNITS_60DAYS,
            COUNT(DISTINCT CASE WHEN PROGRESSION_STATUS = 'Missing Result' AND OVERDUE_RESULT_CLASS = '3. Nearing 60 Days overdue' THEN fact.id END) AS R27_EX_WAIT_UNITS_60DAYS,
            SUM(CASE WHEN PROGRESSION_STATUS = 'Missing Result' AND OVERDUE_RESULT_CLASS = '3. Nearing 60 Days overdue' THEN CLASSHOURSQUANTITY END) AS R27_EX_WAIT_HOURS_60DAYS,
            COUNT(DISTINCT CASE WHEN OVERDUE_RESULT_CLASS = '3. Nearing 60 Days overdue' AND PROGRESSION_STATUS = 'Awaiting Employer Signoff' THEN fact.id END) AS R27_WAIT_UNITS_60DAYS,
            SUM(CASE WHEN OVERDUE_RESULT_CLASS = '3. Nearing 60 Days overdue' AND PROGRESSION_STATUS = 'Awaiting Employer Signoff' THEN CLASSHOURSQUANTITY END) AS R27_WAIT_HOURS_60DAYS,
            SUM(CASE WHEN OVERDUE_RESULT_CLASS = '4. Nearing 90 Days overdue' THEN CLASSHOURSQUANTITY END) AS R27_HOURS_90DAYS,
            COUNT(DISTINCT CASE WHEN OVERDUE_RESULT_CLASS = '4. Nearing 90 Days overdue' THEN fact.id END) AS R27_UNITS_90DAYS,
            COUNT(DISTINCT CASE WHEN PROGRESSION_STATUS = 'Missing Result' AND OVERDUE_RESULT_CLASS = '4. Nearing 90 Days overdue' THEN fact.id END) AS R27_EX_WAIT_UNITS_90DAYS,
            SUM(CASE WHEN PROGRESSION_STATUS = 'Missing Result' AND OVERDUE_RESULT_CLASS = '4. Nearing 90 Days overdue' THEN CLASSHOURSQUANTITY END) AS R27_EX_WAIT_HOURS_90DAYS,
            COUNT(DISTINCT CASE WHEN OVERDUE_RESULT_CLASS = '4. Nearing 90 Days overdue' AND PROGRESSION_STATUS = 'Awaiting Employer Signoff' THEN fact.id END) AS R27_WAIT_UNITS_90DAYS,
            SUM(CASE WHEN OVERDUE_RESULT_CLASS = '4. Nearing 90 Days overdue' AND PROGRESSION_STATUS = 'Awaiting Employer Signoff' THEN CLASSHOURSQUANTITY END) AS R27_WAIT_HOURS_90DAYS,
            SUM(CASE WHEN OVERDUE_RESULT_CLASS = '5. Reject 27 (90+ Days Overdue)' THEN CLASSHOURSQUANTITY END) AS R27_HOURS_OVER90,
            COUNT(DISTINCT CASE WHEN OVERDUE_RESULT_CLASS = '5. Reject 27 (90+ Days Overdue)' THEN fact.id END) AS R27_UNITS_OVER90,
            COUNT(DISTINCT CASE WHEN PROGRESSION_STATUS = 'Missing Result' AND OVERDUE_RESULT_CLASS = '5. Reject 27 (90+ Days Overdue)' THEN fact.id END) AS R27_EX_WAIT_UNITS_OVER90,
            SUM(CASE WHEN PROGRESSION_STATUS = 'Missing Result' AND OVERDUE_RESULT_CLASS = '5. Reject 27 (90+ Days Overdue)' THEN CLASSHOURSQUANTITY END) AS R27_EX_WAIT_HOURS_OVER90,
            COUNT(DISTINCT CASE WHEN OVERDUE_RESULT_CLASS = '5. Reject 27 (90+ Days Overdue)' AND PROGRESSION_STATUS = 'Awaiting Employer Signoff' THEN fact.id END) AS R27_WAIT_UNITS_OVER90,
            SUM(CASE WHEN OVERDUE_RESULT_CLASS = '5. Reject 27 (90+ Days Overdue)' AND PROGRESSION_STATUS = 'Awaiting Employer Signoff' THEN CLASSHOURSQUANTITY END) AS R27_WAIT_HOURS_OVER90
        FROM
            BIST_FACT_CLASS_ENROLMENT Fact
            LEFT OUTER JOIN BIST_DIM_STUDENT STUD ON fact.studentid_fk = stud.surrogate_key
            LEFT OUTER JOIN BIST_DIM_fund_CODE fund ON fact.fund_fk = fund.surrogate_key
            LEFT OUTER JOIN BIST_DIM_STUDENT_GROUP GRP ON FACT.STUDENT_GROUP_FK = grp.surrogate_key
        WHERE
            Fact.date_effective_from <= '{&DATE_KEY_CRITERIA}'
            AND Fact.date_effective_till > '{&DATE_KEY_CRITERIA}'
            AND Fact.year = '{&REPORTING_YEAR}'
        GROUP BY
            fact.year,
            Course_fk,
            fund.fund_group_code,
            fund.fund_group_full_desc,
            fund.fund_summary_code,
            fund.fund_summary_full_desc,
            CAMPUS_FK,
            DEPARTMENTHIER_FK,
            INTAKE_INDICATOR,
            ENROLMENT_TYPE,
            CASE WHEN DEPARTMENTHIER_FK = '18' THEN COL_STUDY_PERIOD
                 ELSE ISNULL(grp.attendancegroupcode, 'Unknown') END,
            CASE WHEN DEPARTMENTHIER_FK = '18' THEN COL_STUDY_PERIOD
                 ELSE ISNULL(grp.name, 'Unknown') END,
            ISNULL(grp.searchkeywords, 'Unknown'),
            ISNULL(grp.notes, 'Unknown')
   

UNION ALL


SELECT
    'F1' AS TableName,
    surrogate_key,
    YEAR,
    student_Count,
    COURSE_FK,
    fund_group_code,
    fund_group_full_desc,
    fund_summary_code,
    fund_summary_full_desc,
    CAMPUS_FK,
    DEPARTMENTHIER_FK,
    IGNORED_HRS,
    GROSS_ENROLLED_HRS,
    ENROLLED_HRS,
    WITHDRAWN_NEVER_ATT_HRS,
    WITHDRAWN_ATTENDED_HRS,
    NETT_ENROLLED_HRS,
    NOT_COMMENCED_HRS,
    YEAR_EFTSL,
    PREENROLLED_HRS,
    COMMENCED_NOT_COMP_HRS,
    SVTS_PAID_AMOUNT,
    SVTS_PAID_HOURS,
    SVTS_REJECT_HOURS,
    SVTS_REJECT_AMOUNT,
    RESULTED_HRS,
    AWAITING_SIGNOFF_HRS,
    INTAKE_INDICATOR,
    ENROLMENT_TYPE,
    INSUFFICIENT_PARTIC_HRS,
    Missing_Attend_Hours,
    Attend_Completed_Hours,
    Attend_in_Progress_Hours,
    Missing_Result_Hours,
    Future_Attenda_Hours,
    Ignored_Attend_Units,
    WNA_UNITS,
    Missing_Attend_Units,
    Attend_Completed_Units,
    Attend_in_Progress_Units,
    Missing_Result_Units,
    Future_Attend_Units,
    attendancegroupcode,
    AttendanceGroupName,
    GroupKeyWords,
    GroupNotes,
    COMMENCED_HOURS,
    CY_CLAIMABLE_SVTS_HOURS,
    YTD_CLAIMABLE_SVTS_HOURS,
    R27_HOURS,
    R27_UNITS,
    R27_EX_WAIT_UNITS,
    R27_EX_WAIT_HOURS,
    R27_WAIT_UNITS,
    R27_WAIT_HOURS,
    R27_HOURS_7DAYS,
    R27_UNITS_7DAYS,
    R27_EX_WAIT_UNITS_7DAYS,
    R27_EX_WAIT_HOURS_7DAYS,
    R27_WAIT_UNITS_7DAYS,
    R27_WAIT_HOURS_7DAYS,
    R27_HOURS_30DAYS,
    R27_UNITS_30DAYS,
    R27_EX_WAIT_UNITS_30DAYS,
    R27_EX_WAIT_HOURS_30DAYS,
    R27_WAIT_UNITS_30DAYS,
    R27_WAIT_HOURS_30DAYS,
    R27_HOURS_60DAYS,
    R27_UNITS_60DAYS,
    R27_EX_WAIT_UNITS_60DAYS,
    R27_EX_WAIT_HOURS_60DAYS,
    R27_WAIT_UNITS_60DAYS,
    R27_WAIT_HOURS_60DAYS,
    R27_HOURS_90DAYS,
    R27_UNITS_90DAYS,
    R27_EX_WAIT_UNITS_90DAYS,
    R27_EX_WAIT_HOURS_90DAYS,
    R27_WAIT_UNITS_90DAYS,
    R27_WAIT_HOURS_90DAYS,
    R27_HOURS_OVER90,
    R27_UNITS_OVER90,
    R27_EX_WAIT_UNITS_OVER90,
    R27_EX_WAIT_HOURS_OVER90,
    R27_WAIT_UNITS_OVER90,
    R27_WAIT_HOURS_OVER90
FROM
    (
    SELECT
        surrogate_key,
        YEAR,
        student_Count,
        COURSE_FK,
        fund_group_code,
        fund_group_full_desc,
        fund_summary_code,
        fund_summary_full_desc,
        CAMPUS_FK,
        DEPARTMENTHIER_FK,
        IGNORED_HRS,
        GROSS_ENROLLED_HRS,
        ENROLLED_HRS,
        WITHDRAWN_NEVER_ATT_HRS,
        WITHDRAWN_ATTENDED_HRS,
        NETT_ENROLLED_HRS,
        NOT_COMMENCED_HRS,
        YEAR_EFTSL,
        PREENROLLED_HRS,
        COMMENCED_NOT_COMP_HRS,
        SVTS_PAID_AMOUNT,
        SVTS_PAID_HOURS,
        SVTS_REJECT_HOURS,
        SVTS_REJECT_AMOUNT,
        RESULTED_HRS,
        AWAITING_SIGNOFF_HRS,
        INTAKE_INDICATOR,
        ENROLMENT_TYPE,
        INSUFFICIENT_PARTIC_HRS,
        Missing_Attend_Hours,
        Attend_Completed_Hours,
        Attend_in_Progress_Hours,
        Missing_Result_Hours,
        Future_Attenda_Hours,
        Ignored_Attend_Units,
        WNA_UNITS,
        Missing_Attend_Units,
        Attend_Completed_Units,
        Attend_in_Progress_Units,
        Missing_Result_Units,
        Future_Attend_Units,
        attendancegroupcode,
        AttendanceGroupName,
        GroupKeyWords,
        GroupNotes,
        COMMENCED_HOURS,
        CY_CLAIMABLE_SVTS_HOURS,
        YTD_CLAIMABLE_SVTS_HOURS,
        R27_HOURS,
        R27_UNITS,
        R27_EX_WAIT_UNITS,
        R27_EX_WAIT_HOURS,
        R27_WAIT_UNITS,
        R27_WAIT_HOURS,
        R27_HOURS_7DAYS,
        R27_UNITS_7DAYS,
        R27_EX_WAIT_UNITS_7DAYS,
        R27_EX_WAIT_HOURS_7DAYS,
        R27_WAIT_UNITS_7DAYS,
        R27_WAIT_HOURS_7DAYS,
        R27_HOURS_30DAYS,
        R27_UNITS_30DAYS,
        R27_EX_WAIT_UNITS_30DAYS,
        R27_EX_WAIT_HOURS_30DAYS,
        R27_WAIT_UNITS_30DAYS,
        R27_WAIT_HOURS_30DAYS,
        R27_HOURS_60DAYS,
        R27_UNITS_60DAYS,
        R27_EX_WAIT_UNITS_60DAYS,
        R27_EX_WAIT_HOURS_60DAYS,
        R27_WAIT_UNITS_60DAYS,
        R27_WAIT_HOURS_60DAYS,
        R27_HOURS_90DAYS,
        R27_UNITS_90DAYS,
        R27_EX_WAIT_UNITS_90DAYS,
        R27_EX_WAIT_HOURS_90DAYS,
        R27_WAIT_UNITS_90DAYS,
        R27_WAIT_HOURS_90DAYS,
        R27_HOURS_OVER90,
        R27_UNITS_OVER90,
        R27_EX_WAIT_UNITS_OVER90,
        R27_EX_WAIT_HOURS_OVER90,
        R27_WAIT_UNITS_OVER90,
        R27_WAIT_HOURS_OVER90
    FROM
        DBO.BIST_FACT_ACT_BUD_VAR
    WHERE
        current_version_flag = 'Y'
        AND year = '{&REPORTING_YEAR}'
        AND dataset_type = 'ACTUALS'
    ) tmp
GROUP BY
    surrogate_key,
    YEAR,
    student_Count,
    COURSE_FK,
    fund_group_code,
    fund_group_full_desc,
    fund_summary_code,
    fund_summary_full_desc,
    CAMPUS_FK,
    DEPARTMENTHIER_FK,
    IGNORED_HRS,
    GROSS_ENROLLED_HRS,
    ENROLLED_HRS,
    WITHDRAWN_NEVER_ATT_HRS,
    WITHDRAWN_ATTENDED_HRS,
    NETT_ENROLLED_HRS,
    NOT_COMMENCED_HRS,
    YEAR_EFTSL,
    PREENROLLED_HRS,
    COMMENCED_NOT_COMP_HRS,
    SVTS_PAID_AMOUNT,
    SVTS_PAID_HOURS,
    SVTS_REJECT_HOURS,
    SVTS_REJECT_AMOUNT,
    RESULTED_HRS,
    AWAITING_SIGNOFF_HRS,
    INTAKE_INDICATOR,
    ENROLMENT_TYPE,
    INSUFFICIENT_PARTIC_HRS,
    Missing_Attend_Hours,
    Attend_Completed_Hours,
    Attend_in_Progress_Hours,
    Missing_Result_Hours,
    Future_Attenda_Hours,
    Ignored_Attend_Units,
    WNA_UNITS,
    Missing_Attend_Units,
    Attend_Completed_Units,
    Attend_in_Progress_Units,
    Missing_Result_Units,
    Future_Attend_Units,
    attendancegroupcode,
    AttendanceGroupName,
    GroupKeyWords,
    GroupNotes,
    COMMENCED_HOURS,
    CY_CLAIMABLE_SVTS_HOURS,
    YTD_CLAIMABLE_SVTS_HOURS,
    R27_HOURS,
    R27_UNITS,
    R27_EX_WAIT_UNITS,
    R27_EX_WAIT_HOURS,
    R27_WAIT_UNITS,
    R27_WAIT_HOURS,
    R27_HOURS_7DAYS,
    R27_UNITS_7DAYS,
    R27_EX_WAIT_UNITS_7DAYS,
    R27_EX_WAIT_HOURS_7DAYS,
    R27_WAIT_UNITS_7DAYS,
    R27_WAIT_HOURS_7DAYS,
    R27_HOURS_30DAYS,
    R27_UNITS_30DAYS,
    R27_EX_WAIT_UNITS_30DAYS,
    R27_EX_WAIT_HOURS_30DAYS,
    R27_WAIT_UNITS_30DAYS,
    R27_WAIT_HOURS_30DAYS,
    R27_HOURS_60DAYS,
    R27_UNITS_60DAYS,
    R27_EX_WAIT_UNITS_60DAYS,
    R27_EX_WAIT_HOURS_60DAYS,
    R27_WAIT_UNITS_60DAYS,
    R27_WAIT_HOURS_60DAYS,
    R27_HOURS_90DAYS,
    R27_UNITS_90DAYS,
    R27_EX_WAIT_UNITS_90DAYS,
    R27_EX_WAIT_HOURS_90DAYS,
    R27_WAIT_UNITS_90DAYS,
    R27_WAIT_HOURS_90DAYS,
    R27_HOURS_OVER90,
    R27_UNITS_OVER90,
    R27_EX_WAIT_UNITS_OVER90,
    R27_EX_WAIT_HOURS_OVER90,
    R27_WAIT_UNITS_OVER90,
    R27_WAIT_HOURS_OVER90
HAVING
    COUNT(*) = 1)changerows


left outer join BIST_FACT_ACT_BUD_VAR code
on
changerows.surrogate_key = code.surrogate_key